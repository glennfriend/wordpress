<?php

use OnrampWooCustomEmailsPlus\App\ServiceProvider;


$build = function()
{

    $_SERVER['REQUEST_METHOD'] = null;
    $_SERVER['SERVER_PROTOCOL'] = null;

    require_once realpath(__DIR__ . '/../../../../vendor/autoload.php');            // composer
    require_once realpath(__DIR__ . '/../../../../wordpress/wp-blog-header.php');   // wordpress
    require_once realpath(__DIR__ . '/../autoloader.php');                          // custom namespace

    $pluginFolder = realpath(__DIR__ . '/..');
    $filename = basename($pluginFolder) . '.php';
    $file = $pluginFolder . '/' . $filename;

    // ================================================================================
    //  check
    // ================================================================================
    if (file_exists($file)) {
        echo $filename . ' is exists!';
        echo "\n";
        exit;
    }

    // ================================================================================
    //  get information
    // ================================================================================
    $provider = new ServiceProvider(__FILE__);
    $provider->init();
    $provider->buildPluginInformation();

    extract($provider->build_plugin_info);
    $className = ServiceProvider::class;

    // ================================================================================
    //  template
    // ================================================================================
    $template = <<<"EOD"

//
// This file is automatically generated
// Please do not modify this file
//

namespace {$provider->namespace};
use {$className};

/**
 * Plugin Name: {$plugin_name}
 * Plugin URI: {$plugin_uri}
 * Description: {$description}
 * Version: {$provider->version}
 * Author: {$author}
 * Author URI: {$author_uri}
 */
defined('ABSPATH') || exit;

if (! class_exists(ServiceProvider::class)) {
    \$init = function() {
        include_once('autoloader.php');
        \$instance = new ServiceProvider(__FILE__);
        \$instance->start();
    };
    \$init();
}

EOD;

    // ================================================================================
    //  build
    // ================================================================================
    $template = '<' . '?' . 'php' . "\n" . $template . "\n";
    file_put_contents($file , $template);

};

$build();
echo "\n";
